# Checkpoint: Bulletproof File Tracking for Multi-Agent Commits

**Date:** 2026-01-08 08:01  
**Bead:** ralph-loop-7jf  
**Status:** In Progress - Design Review Complete

## Context

Working on fixing the multi-agent commit attribution problem in ralph loops. When multiple agents work in the same repo, ralph commits files that other agents edited, attributing them to the wrong task.

## Progress

### Completed
1. ✅ Identified root cause: ralph's `git diff` sees ALL changes, not just current agent's work
2. ✅ Designed hook-based solution using pi-agent's `tool_result` event
3. ✅ Created design doc: `docs/design-file-tracking.md`
4. ✅ Created bead: ralph-loop-7jf
5. ✅ Got expert review via Repo Prompt CLI

### Expert Review Key Findings

**The core approach is sound** - intercepting edit/write tools at the hook level is the right layer.

**Critical refinements needed:**

1. **Remove fallback to `.ralph/current`** - only track when ralph explicitly enables via env vars
2. **Add `RALPH_SESSION`** - unique per task run to isolate concurrent agents on same plan
3. **Fix deletion handling** - use `git add -A -- "$file"` not `git add "$file"`
4. **Clear manifest at task START** - not just after commit, to avoid cross-task leakage

**Enhanced environment contract:**
```bash
RALPH_ROOT="$(git rev-parse --show-toplevel)"
RALPH_PLAN="$(basename "$(get_current_plan)" .md)"
RALPH_TASK="$task_num"
RALPH_SESSION="$(date +%s)-$$"
```

**Manifest structure (revised):**
```
.ralph/manifests/
└── <plan-name>/
    └── <session-id>.txt
```

## Files Created/Modified

- `docs/design-file-tracking.md` - Design document (needs update with review findings)

## Next Steps

1. Update design doc with expert review refinements
2. Implement hook: `~/.pi/agent/hooks/ralph-file-tracker.ts`
3. Add helper functions to `bin/ralph`:
   - `get_plan_name()`
   - `get_repo_root()`
   - `get_manifest_dir()`
   - `start_tracking_session()`
   - `get_tracking_session()`
4. Update Pi launch callsites (`cmd_next`, `cmd_yolo`, `cmd_stuck`) to export env vars
5. Replace `do_commit()` with manifest-based staging
6. Add `.ralph/manifests/` to `.gitignore`
7. Test scenarios: single agent, multi-agent, plan switching, deletions

## Key Decision Point

Need to confirm manifest lifecycle:
- **Option A:** Session-per-task-run (more isolation, more files)
- **Option B:** One manifest per plan, cleared between tasks (simpler, adequate for most cases)

Recommendation from review: Session-per-task-run for true "bulletproof" isolation.

## Conversation Summary

User described multi-agent scenario where Agent 1's ralph loop commits Agent 2's unrelated edits. Explored several solutions:
- Pre-task snapshot (race condition if Agent 2 starts after snapshot)
- Agent self-reporting (unreliable)
- Tool-level tracking via pi-agent hook (chosen approach)

The hook intercepts `edit` and `write` tool calls, logs file paths to a per-plan/per-session manifest. Ralph then only commits files in the manifest, ignoring "foreign" changes from other agents.

Expert review via rp-cli confirmed approach is sound but identified critical refinements for true isolation.
